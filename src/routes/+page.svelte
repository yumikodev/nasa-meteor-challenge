<script lang="ts">
  import { onMount } from "svelte";
  import type { Asteroid } from "../interfaces/neo.interfaces";
  import { goto } from '$app/navigation';

  let dangerousAsteroids: Asteroid[] = [];
  let nonDangerousAsteroids: Asteroid[] = [];
  let loadingAsteroids = true;

  async function fetchAsteroids() {
    try {
      const res = await fetch("/api");
      if (!res.ok) throw new Error("Error fetching asteroids");
      const data = await res.json();
      dangerousAsteroids = data.dangerous || [];
      nonDangerousAsteroids = data.nonDangerous || [];
    } catch (err) {
      console.error("Error obteniendo asteroides:", err);
      dangerousAsteroids = [];
      nonDangerousAsteroids = [];
    } finally {
      loadingAsteroids = false;
    }
  }

  onMount(fetchAsteroids);

  // Env칤a solo id y fecha a /cartesian
  function selectAsteroid(asteroid: Asteroid) {
    const payload = {
      id: asteroid.id,
      nextCloseApproach: asteroid.closeApproachData[0]?.closeApproachDate
    };
    goto('/cartesian', { state: { asteroid: payload } });
  }
</script>

<style>
  :global(body) {
    background-color: #1e3a8a;
    margin: 0;
  }

  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    min-height: 100vh;
    gap: 4rem;
  }

  .asteroid-btn {
    text-align: left;
    border-radius: 0.375rem;
    border: 1px solid #444;
    background-color: #2563eb;
    color: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    transition: background 0.2s;
    cursor: pointer;
    padding: 1rem;
  }

  .asteroid-btn:hover {
    background-color: #1d4ed8;
  }

  .grid-asteroids {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
    gap: 1rem;
    justify-items: center;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
    text-align: center;
  }
</style>

<div class="container">
  <!-- Asteroides peligrosos -->
  <div class="flex flex-col items-center w-full max-w-6xl gap-4">
    <h2 class="section-title">Asteroides peligrosos 游뚿</h2>
    {#if loadingAsteroids}
      <p>Cargando...</p>
    {:else if dangerousAsteroids.length === 0}
      <p>No hay asteroides peligrosos por ahora.</p>
    {:else}
      <div class="grid-asteroids w-full">
        {#each dangerousAsteroids as asteroid (asteroid.id)}
          <button class="asteroid-btn" on:click={() => selectAsteroid(asteroid)}>
            <p class="font-semibold">{asteroid.name}</p>
            <p class="text-sm">Magnitud absoluta: {asteroid.metadata.absoluteMagnitude}</p>
            <p class="text-sm">
              Di치metro estimado: {asteroid.metadata.estimatedDiameter.min.toFixed(2)} - 
              {asteroid.metadata.estimatedDiameter.max.toFixed(2)} km
            </p>
            <p class="text-sm">
              Pr칩ximo acercamiento: {asteroid.closeApproachData[0]?.closeApproachDate}
            </p>
          </button>
        {/each}
      </div>
    {/if}
  </div>

  <!-- Asteroides no peligrosos -->
  <div class="flex flex-col items-center w-full max-w-6xl gap-4">
    <h2 class="section-title">Asteroides no peligrosos 游깿</h2>
    {#if loadingAsteroids}
      <p>Cargando...</p>
    {:else if nonDangerousAsteroids.length === 0}
      <p>No hay asteroides no peligrosos por ahora.</p>
    {:else}
      <div class="grid-asteroids w-full">
        {#each nonDangerousAsteroids as asteroid (asteroid.id)}
          <button class="asteroid-btn" on:click={() => selectAsteroid(asteroid)}>
            <p class="font-semibold">{asteroid.name}</p>
            <p class="text-sm">Magnitud absoluta: {asteroid.metadata.absoluteMagnitude}</p>
            <p class="text-sm">
              Di치metro estimado: {asteroid.metadata.estimatedDiameter.min.toFixed(2)} - 
              {asteroid.metadata.estimatedDiameter.max.toFixed(2)} km
            </p>
            <p class="text-sm">
              Pr칩ximo acercamiento: {asteroid.closeApproachData[0]?.closeApproachDate}
            </p>
          </button>
        {/each}
      </div>
    {/if}
  </div>
</div>
